name: Deploy to VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ‚úÖ L·∫•y full history ƒë·ªÉ c√≥ commit hash
    
    - name: üîß Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    # ‚úÖ QUAN TR·ªåNG: Clear cache c≈©
    - name: üßπ Clean Go cache
      run: |
        go clean -cache -modcache -testcache
        rm -rf ~/go/pkg/mod
    
    - name: üì¶ Download dependencies
      run: |
        go mod download
        go mod verify
    
    # ‚úÖ L·∫•y version info
    - name: üìù Get version info
      id: version
      run: |
        echo "COMMIT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
        echo "BUILD_TIME=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_ENV
        echo "VERSION=$(git describe --tags --always --dirty)" >> $GITHUB_ENV
    
    - name: üîç Run tests
      run: go test -v ./...
    
    # ‚úÖ Build v·ªõi version info v√† force rebuild
    - name: üèóÔ∏è Build binary
      run: |
        GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build \
          -a \
          -ldflags="-s -w -X main.Version=${{ env.VERSION }} -X main.CommitHash=${{ env.COMMIT_HASH }} -X main.BuildTime=${{ env.BUILD_TIME }}" \
          -o myapp ./cmd/server
        
        # Verify binary ƒë∆∞·ª£c build
        ls -lh myapp
        file myapp
        
        # T·∫°o checksum
        sha256sum myapp > myapp.sha256
        cat myapp.sha256
    
    # ‚úÖ Upload c·∫£ binary v√† checksum
    - name: üì§ Upload to VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "myapp,myapp.sha256"
        target: "/tmp/"
        overwrite: true
    
    # ‚úÖ Deploy v·ªõi verify
    - name: üöÄ Deploy on VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          sudo /opt/scripts/deploy-myapp.sh ${{ env.VERSION }} ${{ env.COMMIT_HASH }}
    
    - name: üìä Deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "‚úÖ Deployment successful!"
          echo "Version: ${{ env.VERSION }}"
          echo "Commit: ${{ env.COMMIT_HASH }}"
        else
          echo "‚ùå Deployment failed!"
        fi